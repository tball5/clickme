<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Garage</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Bebas+Neue&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 3rem 1rem 4rem;
      background-color: #c8c8c8;
      font-family: 'DM Mono', monospace;
      transition: background-color 0.4s ease;
      cursor: crosshair;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.08'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 1;
      opacity: 0.4;
    }

    .container {
      position: relative;
      z-index: 2;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
      width: 100%;
      max-width: 600px;
    }

    .title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(3rem, 10vw, 8rem);
      letter-spacing: 0.08em;
      color: #1a1a1a;
      line-height: 1;
      text-shadow: 4px 4px 0px rgba(0,0,0,0.15);
      transition: color 0.4s ease;
      user-select: none;
    }

    .progress-wrap { width: 100%; }
    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #1a1a1a;
      opacity: 0.6;
      margin-bottom: 0.4rem;
      transition: color 0.4s ease;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.15);
      border-radius: 999px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #1a1a1a;
      border-radius: 999px;
      transition: width 0.5s ease, background 0.4s ease;
      width: 0%;
    }

    .counter {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(1rem, 4vw, 2.5rem);
      letter-spacing: 0.2em;
      color: #1a1a1a;
      opacity: 0.55;
      transition: color 0.4s ease;
    }
    .counter span { opacity: 1; font-size: 1.2em; }

    .btn {
      background: #2e2e2e;
      color: #f0f0f0;
      border: none;
      padding: 1.2rem 3rem;
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(1.3rem, 4vw, 2.2rem);
      letter-spacing: 0.2em;
      cursor: pointer;
      position: relative;
      z-index: 10;
      touch-action: manipulation;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.4s ease;
      box-shadow: 6px 6px 0px rgba(0,0,0,0.3);
      clip-path: polygon(0 0, calc(100% - 12px) 0, 100% 12px, 100% 100%, 12px 100%, 0 calc(100% - 12px));
    }
    .btn:hover { transform: translate(-2px,-2px); box-shadow: 8px 8px 0px rgba(0,0,0,0.35); }
    .btn:active { transform: translate(3px,3px); box-shadow: 3px 3px 0px rgba(0,0,0,0.3); }
    .btn.pop { animation: pop 0.15s ease; }
    @keyframes pop {
      0%   { transform: scale(1); }
      40%  { transform: scale(0.93) translate(3px,3px); }
      100% { transform: scale(1); }
    }

    .shade-label {
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #1a1a1a;
      opacity: 0.5;
      transition: color 0.4s ease;
    }
    .shade-label.connecting { animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{opacity:0.3} 50%{opacity:0.7} }

    .divider {
      width: 100%;
      height: 1px;
      background: rgba(0,0,0,0.15);
      transition: background 0.4s ease;
    }

    /* CHAT */
    .chat-section { width: 100%; display: flex; flex-direction: column; gap: 0.75rem; }
    .chat-header {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.4rem;
      letter-spacing: 0.2em;
      color: #1a1a1a;
      transition: color 0.4s ease;
    }
    .chat-count {
      font-size: 0.6rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #1a1a1a;
      opacity: 0.4;
      transition: color 0.4s ease;
    }
    .chat-messages {
      width: 100%;
      max-height: 280px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      padding: 0.5rem;
      background: rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.12);
      transition: background 0.4s ease, border-color 0.4s ease;
    }
    .chat-messages::-webkit-scrollbar { width: 4px; }
    .chat-messages::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 999px; }
    .chat-empty {
      font-size: 0.7rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #1a1a1a;
      opacity: 0.3;
      text-align: center;
      margin: auto;
    }
    .chat-msg {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.5rem 0.6rem;
      background: rgba(255,255,255,0.75);
      border-left: 2px solid rgba(0,0,0,0.2);
      transition: background 0.3s ease;
      animation: fadeIn 0.25s ease;
    }
    @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
    .chat-msg:hover { background: rgba(255,255,255,0.9); }
    .msg-body { flex:1; display:flex; flex-direction:column; gap:0.15rem; }
    .msg-meta { font-size:0.6rem; letter-spacing:0.1em; text-transform:uppercase; color:#1a1a1a; opacity:0.65; }
    .msg-text { font-size:0.8rem; line-height:1.5; color:#1a1a1a !important; word-break:break-word; }
    .msg-delete {
      background: none; border: none; cursor: pointer; color: #1a1a1a;
      opacity: 0.2; font-size: 0.75rem; padding: 0.1rem 0.3rem;
      transition: opacity 0.2s ease; flex-shrink: 0; line-height: 1;
    }
    .msg-delete:hover { opacity: 0.6; }
    .chat-input-wrap { display:flex; gap:0.5rem; flex-wrap:wrap; }
    .chat-name-input {
      width: 130px; flex-shrink: 0;
      background: rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.12);
      color: #1a1a1a; font-family: 'DM Mono', monospace; font-size: 0.7rem;
      letter-spacing: 0.08em; padding: 0.5rem 0.7rem; outline: none;
      text-transform: uppercase; transition: background 0.4s, border-color 0.4s, color 0.4s;
    }
    .chat-text-input {
      flex: 1; min-width: 0;
      background: rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.12);
      color: #1a1a1a; font-family: 'DM Mono', monospace; font-size: 0.75rem;
      padding: 0.5rem 0.7rem; outline: none;
      transition: background 0.4s, border-color 0.4s, color 0.4s;
    }
    .chat-send-btn {
      background: #2e2e2e; color: #f0f0f0; border: none;
      font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem;
      letter-spacing: 0.15em; padding: 0.5rem 1.2rem; cursor: pointer;
      transition: background 0.4s, color 0.4s, opacity 0.2s;
      touch-action: manipulation;
    }
    .chat-send-btn:hover { opacity: 0.8; }

    /* GAMES */
    .pong-section { width:100%; display:flex; flex-direction:column; gap:0.75rem; }
    .pong-header {
      font-family:'Bebas Neue',sans-serif; font-size:1.4rem; letter-spacing:0.2em;
      color:#1a1a1a; transition:color 0.4s ease;
    }
    .pong-wrap { width:100%; display:flex; flex-direction:column; align-items:center; gap:0.5rem; }
    #gameCanvas {
      width:100%; max-width:600px; height:auto; display:block;
      border: 1px solid rgba(0,0,0,0.15);
      cursor: crosshair; touch-action: none;
    }
    .pong-info {
      display:flex; justify-content:space-between; width:100%;
      font-size:0.65rem; letter-spacing:0.15em; text-transform:uppercase;
      color:#1a1a1a; opacity:0.45; transition:color 0.4s ease;
    }
    .pong-start-msg {
      font-size:0.65rem; letter-spacing:0.15em; text-transform:uppercase;
      color:#1a1a1a; opacity:0.4; text-align:center; transition:color 0.4s ease;
    }
    .pong-pause-btn {
      background:none; border:1px solid rgba(0,0,0,0.25); color:#1a1a1a;
      font-family:'Bebas Neue',sans-serif; font-size:0.85rem; letter-spacing:0.15em;
      padding:0.2rem 0.7rem; cursor:pointer; opacity:0.5; transition:opacity 0.2s ease;
    }
    .pong-pause-btn:hover { opacity:1; }

    .shuffle-btn {
      background:none; border:none; color:#1a1a1a;
      font-family:'DM Mono',monospace; font-size:0.6rem;
      letter-spacing:0.12em; text-transform:uppercase;
      cursor:pointer; opacity:0.35; padding:0;
      transition:opacity 0.2s ease, color 0.4s ease;
    }
    .shuffle-btn:hover { opacity:0.8; }
    .shuffle-btn.active { opacity:1; }

    /* PLAYER */
    .player-section { width:100%; display:flex; flex-direction:column; gap:0.75rem; }
    .player-header {
      font-family:'Bebas Neue',sans-serif; font-size:1.4rem; letter-spacing:0.2em;
      color:#1a1a1a; transition:color 0.4s ease; text-align:left;
    }
    .player-box {
      background: rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.12);
      padding: 1rem; display:flex; flex-direction:column; gap:0.8rem;
      transition: background 0.4s, border-color 0.4s;
    }
    .player-now-playing { display:flex; gap:0.8rem; align-items:center; }
    .player-art {
      width:48px; height:48px; background:rgba(0,0,0,0.15); display:flex;
      align-items:center; justify-content:center; font-size:1.4rem; flex-shrink:0;
      transition:background 0.4s;
    }
    .player-info { display:flex; flex-direction:column; gap:0.2rem; }
    .player-track-name {
      font-family:'Bebas Neue',sans-serif; font-size:1rem; letter-spacing:0.12em;
      color:#1a1a1a; transition:color 0.4s;
    }
    .player-track-num {
      font-size:0.6rem; letter-spacing:0.15em; text-transform:uppercase;
      color:#1a1a1a; opacity:0.45; transition:color 0.4s;
    }
    .player-progress-wrap { display:flex; align-items:center; gap:0.5rem; }
    .player-time {
      font-size:0.6rem; letter-spacing:0.08em; color:#1a1a1a; opacity:0.5;
      flex-shrink:0; min-width:28px; transition:color 0.4s;
    }
    .player-time.right { text-align:right; }
    .player-scrubber {
      flex:1; -webkit-appearance:none; appearance:none; height:3px;
      background:rgba(0,0,0,0.15); border-radius:999px; outline:none; cursor:pointer;
    }
    .player-scrubber::-webkit-slider-thumb {
      -webkit-appearance:none; width:10px; height:10px; border-radius:50%;
      background:#1a1a1a; cursor:pointer; transition:background 0.4s;
    }
    .player-controls { display:flex; justify-content:center; align-items:center; gap:1.2rem; }
    .ctrl-btn {
      background:none; border:none; cursor:pointer; color:#1a1a1a;
      font-size:1rem; opacity:0.5; transition:opacity 0.2s, transform 0.1s, color 0.4s;
      padding:0.2rem;
    }
    .ctrl-btn:hover { opacity:1; transform:scale(1.1); }
    .ctrl-btn:active { transform:scale(0.95); }
    .ctrl-btn.play-pause {
      font-size:1.6rem; opacity:0.85; width:44px; height:44px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.1); border-radius:50%;
    }
    .ctrl-btn.play-pause:hover { opacity:1; background:rgba(0,0,0,0.18); }
    .player-volume-wrap { display:flex; align-items:center; gap:0.5rem; }
    .vol-icon { font-size:0.8rem; color:#1a1a1a; opacity:0.4; flex-shrink:0; transition:color 0.4s; }
    .player-volume {
      flex:1; -webkit-appearance:none; appearance:none; height:3px;
      background:rgba(0,0,0,0.15); border-radius:999px; outline:none; cursor:pointer;
    }
    .player-volume::-webkit-slider-thumb {
      -webkit-appearance:none; width:10px; height:10px; border-radius:50%;
      background:#1a1a1a; cursor:pointer;
    }
    .track-list { display:flex; flex-direction:column; gap:0.3rem; }
    .track-item {
      display:flex; align-items:center; gap:0.6rem; padding:0.4rem 0.3rem;
      cursor:pointer; opacity:0.6; transition:opacity 0.2s;
    }
    .track-item:hover { opacity:1; }
    .track-item.active { opacity:1; }
    .track-num {
      font-size:0.6rem; letter-spacing:0.1em; color:#1a1a1a;
      min-width:16px; text-align:right; flex-shrink:0; transition:color 0.4s;
    }
    .eq-bars { display:flex; align-items:flex-end; gap:1.5px; height:14px; flex-shrink:0; }
    .bar {
      width:2.5px; background:#1a1a1a; border-radius:1px;
      animation:none; opacity:0.6;
      transform: scaleY(0.4);
    }
    .bar:nth-child(1){height:8px}
    .bar:nth-child(2){height:12px}
    .bar:nth-child(3){height:6px}
    .track-item.active .bar {
      animation:barBounce 0.6s ease-in-out infinite alternate;
    }
    .track-item.active .bar:nth-child(1){animation-delay:0s}
    .track-item.active .bar:nth-child(2){animation-delay:0.15s}
    .track-item.active .bar:nth-child(3){animation-delay:0.3s}
    .track-item.active.paused .bar { animation-play-state:paused; }
    @keyframes barBounce { 0%,100%{transform:scaleY(0.4)} 50%{transform:scaleY(1)} }
    .track-name-label {
      font-size:0.75rem; letter-spacing:0.04em; color:#1a1a1a; flex:1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; transition:color 0.4s;
    }

    .ripple {
      position:fixed; border-radius:50%; width:10px; height:10px;
      background:rgba(0,0,0,0.08); transform:translate(-50%,-50%) scale(0);
      animation:rippleOut 0.6s ease-out forwards; pointer-events:none; z-index:0;
    }
    @keyframes rippleOut { to{transform:translate(-50%,-50%) scale(40);opacity:0} }
  </style>
</head>
<body>

<div class="container">

  <div class="title" id="title">THE<br>GARAGE</div>

  <div class="progress-wrap">
    <div class="progress-label" id="progressLabel">
      <span></span>
      <span id="pct">0%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="fill"></div>
    </div>
  </div>

  <div class="counter" id="counter">
    <span id="count">0</span> / 1,000,000
  </div>

  <button class="btn" id="clickBtn" disabled>CLICK ME, HOMIE!</button>

  <div class="shade-label connecting" id="shadeLabel">CONNECTING...</div>

  <div class="divider" id="divider"></div>

  <!-- CHAT -->
  <div class="chat-section">
    <div style="display:flex;justify-content:space-between;align-items:baseline;">
      <div class="chat-header" id="chatHeader">CHAT</div>
      <div class="chat-count" id="chatCount"></div>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-empty" id="chatEmpty">NO MESSAGES YET. BE THE FIRST.</div>
    </div>
    <div class="chat-input-wrap">
      <input class="chat-name-input" id="nameInput" type="text" placeholder="YOUR NAME" maxlength="20" autocomplete="off"/>
      <input class="chat-text-input" id="msgInput"  type="text" placeholder="SAY SOMETHING..." maxlength="200" autocomplete="off"/>
      <button class="chat-send-btn" id="sendBtn">SEND</button>
    </div>
  </div>

  <div class="divider" id="divider2"></div>

  <!-- GAMES -->
  <div class="pong-section">
    <div style="display:flex;justify-content:space-between;align-items:baseline;">
      <div class="pong-header" id="pongHeader">PONG</div>
      <button class="pong-pause-btn" id="pongPauseBtn" style="display:none;">PAUSE</button>
    </div>
    <div class="pong-wrap">
      <canvas id="gameCanvas" width="400" height="500"></canvas>
      <div class="pong-info">
        <span id="gameLeft">YOU: 0</span>
        <span class="pong-start-msg" id="pongMsg">CLICK TO START</span>
        <span id="gameRight">CPU: 0</span>
      </div>
    </div>
  </div>

  <div class="divider" id="divider3"></div>

  <!-- MUSIC PLAYER -->
  <div class="player-section">
    <div style="display:flex;justify-content:space-between;align-items:baseline;">
      <div class="player-header" id="playerHeader">TRACKS</div>
      <button class="shuffle-btn" id="shuffleBtn" title="Shuffle">&#8645; SHUFFLE</button>
    </div>
    <div class="player-box" id="playerBox">
      <div class="player-now-playing">
        <div class="player-art" id="playerArt">&#127925;</div>
        <div class="player-info">
          <div class="player-track-name" id="playerTrackName">SELECT A TRACK</div>
          <div class="player-track-num"  id="playerTrackNum">&#8212; / 7</div>
        </div>
      </div>
      <div class="player-progress-wrap">
        <div class="player-time" id="timeElapsed">0:00</div>
        <input class="player-scrubber" id="scrubber" type="range" min="0" max="100" value="0"/>
        <div class="player-time right" id="timeDuration">0:00</div>
      </div>
      <div class="player-controls">
        <button class="ctrl-btn" id="prevBtn" title="Previous">&#9664;&#9664;</button>
        <button class="ctrl-btn play-pause" id="playPauseBtn" title="Play">&#9654;</button>
        <button class="ctrl-btn" id="nextBtn" title="Next">&#9654;&#9654;</button>
      </div>
      <div class="player-volume-wrap">
        <span class="vol-icon">&#9651;</span>
        <input class="player-volume" id="volumeSlider" type="range" min="0" max="1" step="0.01" value="0.8"/>
      </div>
      <div class="track-list" id="trackList"></div>
    </div>
  </div>

</div>

<script>
  /* ── FIREBASE ── */
  var firebaseConfig = {
    apiKey: "AIzaSyCHIDtqYhDi5EyCwbtTvAZGS0Nd4-3dkhE",
    authDomain: "click-me-8c931.firebaseapp.com",
    databaseURL: "https://click-me-8c931-default-rtdb.firebaseio.com",
    projectId: "click-me-8c931",
    storageBucket: "click-me-8c931.appspot.com",
    messagingSenderId: "206668014",
    appId: "1:206668014:web:abc123"
  };
  firebase.initializeApp(firebaseConfig);
  var db        = firebase.database();
  var auth      = firebase.auth();
  var clickRef  = db.ref('clicks');
  var msgsRef   = db.ref('messages');
  var MAX_MSGS  = 300;
  var GOAL      = 1000000;

  /* ── SHADES ── */
  var shades = [];
  (function(){
    var step = (240-40)/49;
    for(var i=0;i<50;i++) shades.push(Math.round(240 - i*step));
  })();

  /* ── DOM refs ── */
  var titleEl     = document.getElementById('title');
  var counterEl   = document.getElementById('counter');
  var countEl     = document.getElementById('count');
  var fillEl      = document.getElementById('fill');
  var pctEl       = document.getElementById('pct');
  var shadeEl     = document.getElementById('shadeLabel');
  var dividerEl   = document.getElementById('divider');
  var progressLbl = document.getElementById('progressLabel');
  var btn         = document.getElementById('clickBtn');
  var chatHeader  = document.getElementById('chatHeader');
  var chatCount   = document.getElementById('chatCount');
  var chatMessages= document.getElementById('chatMessages');
  var nameInput   = document.getElementById('nameInput');
  var msgInput    = document.getElementById('msgInput');
  var sendBtn     = document.getElementById('sendBtn');
  var currentAccent = '#1a1a1a';
  var pongPageBg    = '#c8c8c8';

  /* ── UPDATE UI ── */
  function updateUI(count) {
    countEl.textContent = count.toLocaleString();
    var pct = Math.min((count/GOAL)*100, 100);
    fillEl.style.width = pct.toFixed(2)+'%';
    pctEl.textContent  = pct.toFixed(2)+'%';
    var idx        = count % 50;
    var brightness = shades[idx];
    var bg         = 'rgb('+brightness+','+brightness+','+brightness+')';
    document.body.style.backgroundColor = bg;
    var accent = brightness < 128 ? '#f0f0f0' : '#1a1a1a';
    var btnBg  = brightness < 128 ? '#e0e0e0' : '#2e2e2e';
    var btnTxt = brightness < 128 ? '#1a1a1a' : '#f0f0f0';
    var inputBg  = brightness < 128 ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)';
    var inputBdr = brightness < 128 ? 'rgba(255,255,255,0.2)'  : 'rgba(0,0,0,0.15)';
    var divBg    = brightness < 128 ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.15)';
    currentAccent = accent;
    pongPageBg    = bg;

    titleEl.style.color        = accent;
    counterEl.style.color      = accent;
    shadeEl.style.color        = accent;
    fillEl.style.background    = accent;
    btn.style.background       = btnBg;
    btn.style.color            = btnTxt;
    dividerEl.style.background = divBg;
    var labelSpans = progressLbl.querySelectorAll('span');
    for(var s=0;s<labelSpans.length;s++) labelSpans[s].style.color = accent;
    shadeEl.classList.remove('connecting');
    shadeEl.textContent = 'SHADE '+String(idx+1).padStart(2,'0')+' OF 50';

    chatHeader.style.color          = accent;
    chatCount.style.color           = accent;
    nameInput.style.background      = inputBg;
    nameInput.style.borderColor     = inputBdr;
    nameInput.style.color           = accent;
    msgInput.style.background       = inputBg;
    msgInput.style.borderColor      = inputBdr;
    msgInput.style.color            = accent;
    chatMessages.style.background   = brightness < 128 ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.06)';
    chatMessages.style.borderColor  = inputBdr;
    sendBtn.style.background        = btnBg;
    sendBtn.style.color             = btnTxt;

    var d2=document.getElementById('divider2'); if(d2) d2.style.background=divBg;
    var d3=document.getElementById('divider3'); if(d3) d3.style.background=divBg;

    var ph=document.getElementById('pongHeader');
    if(ph) ph.style.color=accent;

    var ph=document.getElementById('playerHeader'),pbox=document.getElementById('playerBox');
    var sb=document.getElementById('shuffleBtn'); if(sb) sb.style.color=accent;    var pa=document.getElementById('playerArt'),ptn=document.getElementById('playerTrackName');
    var ptnum=document.getElementById('playerTrackNum'),te=document.getElementById('timeElapsed');
    var td=document.getElementById('timeDuration'),sc=document.getElementById('scrubber');
    var vs=document.getElementById('volumeSlider');
    if(ph)    ph.style.color=accent;
    if(pbox)  { pbox.style.background=inputBg; pbox.style.borderColor=inputBdr; }
    if(pa)    pa.style.background=brightness<128?'rgba(255,255,255,0.1)':'rgba(0,0,0,0.15)';
    if(ptn)   ptn.style.color=accent;
    if(ptnum) ptnum.style.color=accent;
    if(te)    te.style.color=accent;
    if(td)    td.style.color=accent;
    if(sc)    sc.style.background=brightness<128?'rgba(255,255,255,0.15)':'rgba(0,0,0,0.15)';
    if(vs)    vs.style.background=brightness<128?'rgba(255,255,255,0.15)':'rgba(0,0,0,0.15)';
    var cbs=document.querySelectorAll('.ctrl-btn');
    for(var c=0;c<cbs.length;c++) cbs[c].style.color=accent;
    var tls=document.querySelectorAll('.track-name-label,.track-num,.vol-icon');
    for(var t=0;t<tls.length;t++) tls[t].style.color=accent;
    var bars=document.querySelectorAll('.bar');
    for(var b=0;b<bars.length;b++) bars[b].style.background=accent;
  }

  /* ── CLICK LISTENER ── */
  clickRef.on('value', function(snap) {
    var val = snap.val(); if(val===null) val=0;
    updateUI(val);
    btn.disabled = false;
  });

  btn.addEventListener('click', function(e) {
    var ripple = document.createElement('div');
    ripple.className = 'ripple';
    ripple.style.left = e.clientX+'px';
    ripple.style.top  = e.clientY+'px';
    document.body.appendChild(ripple);
    setTimeout(function(){ if(ripple.parentNode) ripple.parentNode.removeChild(ripple); }, 700);
    btn.classList.remove('pop');
    void btn.offsetWidth;
    btn.classList.add('pop');
    clickRef.transaction(function(current) { return (current||0)+1; });
  });

  /* ── AUTH ── */
  auth.signInAnonymously().catch(function(err){ console.warn('Auth failed:', err); });

  /* ── CHAT ── */
  function formatTime(ts) {
    var d = Date.now()-ts, s=Math.floor(d/1000), m=Math.floor(s/60), h=Math.floor(m/60);
    if(s<60) return s+'s ago';
    if(m<60) return m+'m ago';
    if(h<24) return h+'h ago';
    return Math.floor(h/24)+'d ago';
  }

  function renderMsg(id, data) {
    var chatEmpty = document.getElementById('chatEmpty');
    if(chatEmpty) chatEmpty.remove();
    var el = document.createElement('div');
    el.className = 'chat-msg'; el.id = 'msg-'+id;
    var body = document.createElement('div'); body.className='msg-body';
    var meta = document.createElement('div'); meta.className='msg-meta';
    meta.textContent = (data.name||'ANON')+' · '+formatTime(data.ts);
    var text = document.createElement('div'); text.className='msg-text';
    text.textContent = data.text;
    body.appendChild(meta); body.appendChild(text);
    var del = document.createElement('button'); del.className='msg-delete'; del.textContent='x';
    del.addEventListener('click', function(){ msgsRef.child(id).remove(); });
    el.appendChild(body); el.appendChild(del);
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  msgsRef.on('child_added', function(snap){ renderMsg(snap.key, snap.val()); });
  msgsRef.on('child_removed', function(snap){
    var el=document.getElementById('msg-'+snap.key);
    if(el) el.remove();
    if(chatMessages.children.length===0){
      var e=document.createElement('div');e.className='chat-empty';e.id='chatEmpty';
      e.textContent='NO MESSAGES YET. BE THE FIRST.';chatMessages.appendChild(e);
    }
  });
  msgsRef.on('value', function(snap){
    var c=snap.numChildren();
    chatCount.textContent=c>0?c+'/'+MAX_MSGS+' MESSAGES':'';
  });

  function sendMessage() {
    var text = msgInput.value.trim(); if(!text) return;
    if(!auth.currentUser) { alert('Still connecting, try again!'); return; }
    var name = (nameInput.value.trim()||'ANON').toUpperCase();
    msgsRef.once('value', function(snap){
      if(snap.numChildren()>=MAX_MSGS){
        var keys=[];snap.forEach(function(c){keys.push(c.key);});
        msgsRef.child(keys[0]).remove();
      }
      msgsRef.push({name:name,text:text,ts:Date.now()});
    });
    msgInput.value='';
  }
  sendBtn.addEventListener('click', sendMessage);
  msgInput.addEventListener('keydown', function(e){ if(e.key==='Enter') sendMessage(); });

  /* ── MUSIC PLAYER ── */
  var tracks = [
    { name:'Lil Couch',       file:'Lil_Couch.mp3' },
    { name:'Juice',           file:'Juice.mp3' },
    { name:'Rainbow Warhead', file:'rainbow_warhead.mp3' },
    { name:'Moonlight Asada', file:'moonlight_asada.mp3' },
    { name:'White Lightning', file:'White_Lightning.mp3' },
    { name:'Super',           file:'Super.mp3' },
    { name:'Flat Earth',      file:'flat_earth.mp3' }
  ];

  var audio        = new Audio();
  var currentTrack = 0;
  var isPlaying    = false;
  var shuffleOn    = false;

  var playerTrackName = document.getElementById('playerTrackName');
  var playerTrackNum  = document.getElementById('playerTrackNum');
  var playPauseBtn    = document.getElementById('playPauseBtn');
  var prevBtn         = document.getElementById('prevBtn');
  var nextBtn         = document.getElementById('nextBtn');
  var scrubber        = document.getElementById('scrubber');
  var volumeSlider    = document.getElementById('volumeSlider');
  var timeElapsed     = document.getElementById('timeElapsed');
  var timeDuration    = document.getElementById('timeDuration');
  var trackList       = document.getElementById('trackList');

  function fmtTime(s){ var m=Math.floor(s/60),sec=Math.floor(s%60); return m+':'+(sec<10?'0':'')+sec; }

  function loadTrack(idx, play) {
    currentTrack = idx;
    audio.src = tracks[idx].file;
    playerTrackName.textContent = tracks[idx].name;
    playerTrackNum.textContent  = (idx+1)+' / '+tracks.length;
    scrubber.value = 0; timeElapsed.textContent='0:00'; timeDuration.textContent='0:00';
    var items = document.querySelectorAll('.track-item');
    items.forEach(function(item,i){
      item.classList.toggle('active', i===idx);
      item.classList.remove('paused');
    });
    if(play){ audio.play(); isPlaying=true; playPauseBtn.innerHTML='&#9646;&#9646;'; }
    else { isPlaying=false; playPauseBtn.innerHTML='&#9654;'; }
  }

  function buildTrackList() {
    trackList.innerHTML='';
    tracks.forEach(function(t,i){
      var item=document.createElement('div');item.className='track-item';item.id='track-'+i;
      var num=document.createElement('div');num.className='track-num';num.textContent=String(i+1).padStart(2,'0');
      var eq=document.createElement('div');eq.className='eq-bars';
      for(var b=0;b<3;b++){var bar=document.createElement('div');bar.className='bar';eq.appendChild(bar);}
      var label=document.createElement('div');label.className='track-name-label';label.textContent=t.name;
      item.appendChild(num);item.appendChild(eq);item.appendChild(label);
      item.addEventListener('click',function(idx){return function(){loadTrack(idx,true);};}(i));
      trackList.appendChild(item);
    });
  }

  playPauseBtn.addEventListener('click', function(){
    if(isPlaying){
      audio.pause(); isPlaying=false; playPauseBtn.innerHTML='&#9654;';
      var ai=document.getElementById('track-'+currentTrack);if(ai)ai.classList.add('paused');
    } else {
      if(!audio.src||audio.src===window.location.href) loadTrack(0,true);
      else { audio.play(); isPlaying=true; playPauseBtn.innerHTML='&#9646;&#9646;';
        var ai2=document.getElementById('track-'+currentTrack);if(ai2)ai2.classList.remove('paused'); }
    }
  });
  audio.addEventListener('timeupdate',function(){
    if(!audio.duration)return;
    scrubber.value=(audio.currentTime/audio.duration)*100;
    timeElapsed.textContent=fmtTime(audio.currentTime);
    timeDuration.textContent=fmtTime(audio.duration);
  });
  scrubber.addEventListener('input',function(){
    if(!audio.duration)return;
    audio.currentTime=(scrubber.value/100)*audio.duration;
  });
  volumeSlider.addEventListener('input',function(){ audio.volume=volumeSlider.value; });
  prevBtn.addEventListener('click',function(){ loadTrack(currentTrack<=0?tracks.length-1:currentTrack-1,isPlaying); });
  nextBtn.addEventListener('click',function(){ loadTrack(currentTrack>=tracks.length-1?0:currentTrack+1,isPlaying); });
  audio.addEventListener('ended',function(){
    if(shuffleOn){
      var next;
      do { next=Math.floor(Math.random()*tracks.length); } while(tracks.length>1&&next===currentTrack);
      loadTrack(next,true);
    } else {
      loadTrack(currentTrack<tracks.length-1?currentTrack+1:0, currentTrack<tracks.length-1);
    }
  });

  var shuffleBtn = document.getElementById('shuffleBtn');
  shuffleBtn.addEventListener('click',function(){
    shuffleOn = !shuffleOn;
    shuffleBtn.classList.toggle('active', shuffleOn);
    shuffleBtn.style.opacity = shuffleOn ? '1' : '0.35';
  });

  buildTrackList();

  /* ════════════
     PONG GAME
     ════════════ */
  var gameCanvas   = document.getElementById('gameCanvas');
  var ctx          = gameCanvas.getContext('2d');
  var pongPauseBtn = document.getElementById('pongPauseBtn');
  var pongMsgEl    = document.getElementById('pongMsg');
  var gameLeftEl   = document.getElementById('gameLeft');
  var gameRightEl  = document.getElementById('gameRight');
  var CW=400, CH=500;
  var PADDLE_W=70, PADDLE_H=12, BALL_SIZE=8, WIN_SCORE=7;
  var pongState='idle', playerScore=0, cpuScore=0, pongRaf=null;
  var paddle    = {x:CW/2-PADDLE_W/2, y:CH-30, w:PADDLE_W, h:PADDLE_H};
  var cpuPaddle = {x:CW/2-PADDLE_W/2, y:18,    w:PADDLE_W, h:PADDLE_H};
  var pongBall  = {x:CW/2, y:CH/2, vx:3, vy:4, size:BALL_SIZE};
  var mouseX=CW/2, touchX=null, keysDown={};

  gameCanvas.addEventListener('mousemove',function(e){
    var r=gameCanvas.getBoundingClientRect();
    mouseX=(e.clientX-r.left)*(CW/r.width);
  });
  gameCanvas.addEventListener('touchmove',function(e){
    e.stopPropagation();
    var r=gameCanvas.getBoundingClientRect();
    touchX=(e.touches[0].clientX-r.left)*(CW/r.width);
    if(pongState==='playing') e.preventDefault();
  },{passive:false});
  gameCanvas.addEventListener('touchend',function(){ touchX=null; });
  gameCanvas.addEventListener('click',function(){
    if(pongState==='idle'||pongState==='over') startPong();
    else if(pongState==='paused') resumePong();
  });
  pongPauseBtn.addEventListener('click',function(e){
    e.stopPropagation();
    if(pongState==='playing') pausePong();
    else if(pongState==='paused') resumePong();
  });
  document.addEventListener('keydown',function(e){
    keysDown[e.key]=true;
    if((e.key==='ArrowLeft'||e.key==='ArrowRight')&&pongState==='playing') e.preventDefault();
    if(e.key==='p'||e.key==='P'){if(pongState==='playing')pausePong();else if(pongState==='paused')resumePong();}
  });
  document.addEventListener('keyup',function(e){ keysDown[e.key]=false; });

  function drawPong(){
    ctx.fillStyle=pongPageBg; ctx.fillRect(0,0,CW,CH);
    ctx.save(); ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(0,0,0,0.12)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(0,CH/2); ctx.lineTo(CW,CH/2); ctx.stroke(); ctx.restore();
    ctx.fillStyle='#1a1a1a';
    ctx.fillRect(paddle.x,paddle.y,paddle.w,paddle.h);
    ctx.fillRect(cpuPaddle.x,cpuPaddle.y,cpuPaddle.w,cpuPaddle.h);
    ctx.beginPath(); ctx.arc(pongBall.x,pongBall.y,pongBall.size,0,Math.PI*2); ctx.fill();
  }
  function startPong(){
    playerScore=0; cpuScore=0; paddle.x=cpuPaddle.x=CW/2-PADDLE_W/2;
    pongState='playing'; pongPauseBtn.style.display='block'; pongPauseBtn.textContent='PAUSE';
    pongMsgEl.textContent='FIRST TO '+WIN_SCORE+' - P TO PAUSE';
    gameLeftEl.textContent='YOU: 0'; gameRightEl.textContent='CPU: 0';
    resetPongBall();
    if(pongRaf) cancelAnimationFrame(pongRaf);
    pongRaf=requestAnimationFrame(pongLoop);
  }
  function pausePong(){
    pongState='paused'; pongPauseBtn.textContent='RESUME'; pongMsgEl.textContent='PAUSED';
    if(pongRaf){cancelAnimationFrame(pongRaf);pongRaf=null;}
    drawPong();
  }
  function resumePong(){
    pongState='playing'; pongPauseBtn.textContent='PAUSE';
    pongMsgEl.textContent='FIRST TO '+WIN_SCORE+' - P TO PAUSE';
    pongRaf=requestAnimationFrame(pongLoop);
  }
  function endPong(w){
    pongState='over'; pongPauseBtn.style.display='none';
    if(pongRaf){cancelAnimationFrame(pongRaf);pongRaf=null;}
    pongMsgEl.textContent=(w==='player'?'YOU WIN!':'CPU WINS!')+' - CLICK TO PLAY AGAIN';
    drawPong();
  }
  function resetPongBall(){
    pongBall.x=CW/2; pongBall.y=CH/2;
    pongBall.vx=(2+Math.random())*(Math.random()>0.5?1:-1);
    pongBall.vy=(3.5+Math.random())*(Math.random()>0.5?1:-1);
  }
  function pongLoop(){
    if(pongState!=='playing') return;
    if(keysDown['ArrowLeft'])  paddle.x-=6;
    if(keysDown['ArrowRight']) paddle.x+=6;
    var tx=(touchX!==null?touchX:mouseX)-PADDLE_W/2;
    paddle.x+=(tx-paddle.x)*0.2;
    paddle.x=Math.max(0,Math.min(CW-PADDLE_W,paddle.x));
    var cc=cpuPaddle.x+PADDLE_W/2, cs=Math.min(3+Math.abs(pongBall.vy)*0.1,5.5);
    if(pongBall.vy<0){if(cc<pongBall.x-4)cpuPaddle.x+=cs;else if(cc>pongBall.x+4)cpuPaddle.x-=cs;}
    else{if(cc<CW/2-8)cpuPaddle.x+=cs*0.3;else if(cc>CW/2+8)cpuPaddle.x-=cs*0.3;}
    cpuPaddle.x=Math.max(0,Math.min(CW-PADDLE_W,cpuPaddle.x));
    pongBall.x+=pongBall.vx; pongBall.y+=pongBall.vy;
    if(pongBall.x-pongBall.size<0){pongBall.x=pongBall.size;pongBall.vx*=-1;}
    if(pongBall.x+pongBall.size>CW){pongBall.x=CW-pongBall.size;pongBall.vx*=-1;}
    if(pongBall.vy>0&&pongBall.y+pongBall.size>=paddle.y&&pongBall.y+pongBall.size<=paddle.y+paddle.h+4&&pongBall.x>=paddle.x&&pongBall.x<=paddle.x+paddle.w){
      pongBall.y=paddle.y-pongBall.size;
      pongBall.vx=((pongBall.x-(paddle.x+PADDLE_W/2))/(PADDLE_W/2))*5;
      pongBall.vy=-Math.min(Math.abs(pongBall.vy)*1.05,11);
    }
    if(pongBall.vy<0&&pongBall.y-pongBall.size<=cpuPaddle.y+cpuPaddle.h&&pongBall.y-pongBall.size>=cpuPaddle.y-4&&pongBall.x>=cpuPaddle.x&&pongBall.x<=cpuPaddle.x+cpuPaddle.w){
      pongBall.y=cpuPaddle.y+cpuPaddle.h+pongBall.size;
      pongBall.vx=((pongBall.x-(cpuPaddle.x+PADDLE_W/2))/(PADDLE_W/2))*5;
      pongBall.vy=Math.min(Math.abs(pongBall.vy)*1.05,11);
    }
    if(pongBall.y-pongBall.size>CH){cpuScore++;gameLeftEl.textContent='YOU: '+playerScore;gameRightEl.textContent='CPU: '+cpuScore;if(cpuScore>=WIN_SCORE){endPong('cpu');return;}resetPongBall();}
    if(pongBall.y+pongBall.size<0){playerScore++;gameLeftEl.textContent='YOU: '+playerScore;gameRightEl.textContent='CPU: '+cpuScore;if(playerScore>=WIN_SCORE){endPong('player');return;}resetPongBall();}
    drawPong();
    pongRaf=requestAnimationFrame(pongLoop);
  }

  drawPong();
</script>
</body>
</html>
